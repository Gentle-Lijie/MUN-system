# 数据库结构 - 更新

## Core Identity Tables

### Users

- **id** — 全局唯一用户标识，用于所有外键引用和审计记录。
- **name** — 用户显示名，用于界面展示与会话时称呼。
- **email** — 登录和通知用邮箱，系统用于唯一验证和找回密码。
- **password_hash** — 存储经过安全哈希的密码字符串，不明文保存。
- **role** — enum: admin/dais/delegate
- **organization** — 用户所属代表团或学校，用于分组、统计与权限判断。
- **phone** — 可选联系方式，用于验证码或主办方联络。
- **last_login** — 最近一次成功登录时间，用于安全监控与活跃度报表。
- **created_at** — 账户创建时间，用于审计与生命周期管理。
- **updated_at** — 最后一次信息修改时间，用于并发与历史追踪。

### Permissions

- **id** — 主键。
- **role_id** — 指向某个角色，表示该条权限属于哪个角色。
- **permission_key** — 权限标识字符串（例如 motion.create、veto.cast），用于程序内判断。
- **allowed** — 布尔值，表示该角色是否被授予该权限。

------

## 会场、代表与会期管理

### Committees

- **id** — 会场实体主键。
- **code** — 简短标识（如 GA1），便于前端快速筛选与统计报表。
- **name** — 会场全称，用于显示与搜索。
- **venue** — 会场实际举办地点或线上标识，用于调度与通知。
- **description** — 会场说明、议题范围或特殊规则。
- **status** — 会场当前状态（preparation / in_session / paused / closed）。
- **agenda_order** — 存储议程顺序或议程版本信息，支持拖拽变更后回溯。
- **dais_json** — 当前主席团成员与联系方式的结构化信息（或改为关联表）。
- **created_by** — 创建该会场的管理员用户 id。
- **created_at** — 创建时间。
- **updated_at** — 最后修改时间。

### Delegates

- **id** — 代表条目主键（代表在某会场的身份）。
- **user_id** — 关联 Users，便于登录与权限映射。
- **committee_id** — 代表所属会场，连接到 Committees。
- **country** — 代表国家或派遣实体，做为发言与投票的主体身份。
- **veto_allowed** — 是否被赋予否决资格，用于否决操作许可判断。
- **role_in_committee** — 在会场中的角色标签（delegate、head_delegate、advisor 等），影响权限。
- **status** — 代表当前状态（active/absent），用于点名与统计。
- **created_at** — 记录创建时间。
- **updated_at** — 最近一次更新。

### Sessions

> Session包括
>
> |                                | 发起国家 | 单位时间 | 总时间 | 附议 | 投票通过 | 有发言名单 | 备注                       |
> | ------------------------------ | -------- | -------- | ------ | ---- | -------- | ---------- | -------------------------- |
> | 1.开启主发言名单；             | √        | √        | √      | √    | √        | √          |                            |
> | 2.有主持核心磋商；             | √        | √        | √      | √    | √        | √          |                            |
> | 3.自由磋商；                   | √        |          | √      | √    | √        |            |                            |
> | 4.自由辩论；                   | √        |          | √      | √    | √        |            |                            |
> | 5.质询权；                     | √        |          |        |      |          |            |                            |
> | 6.进入特殊状态（时间轴改变）； | √        |          |        | √    | √        |            |                            |
> | 7.退出特殊状态（时间轴改变）； | √        |          |        | √    | √        |            |                            |
> | 8.休会；                       | √        |          |        | √    | √        |            |                            |
> | 9.阅读文件;                    | √        |          | √      | √    | √        |            |                            |
> | 10.个人演讲；                  | √        |          | √      | √    | √        |            |                            |
> | 11.对文件投票；                | √        |          |        | √    | √        |            | 否决权（要能设定相关国家） |
> | 12.答辩权；                    | √        |          | √      |      |          |            |                            |

- **id** — 会期或动议会话主键。
- **committee_id** — 该会期属于哪个会场。
- **type** — 会期类型（main_list/moderated/unmoderated/special/other），用于决定可用操作与计时规则。
- **unit_time_seconds** — 单位时间长度（用于动议设定或发言时长），以秒计。
- **total_time_seconds** — 会期总时长（秒），用于倒计时与自动结束。
- **proposer_id** — 发起该会期或动议的代表 id，用于责任追踪。
- **is_approved** — 是否已被通过/批准（布尔），作为会期生效条件。
- **vote_result** — 结构化存储该会期相关投票的汇总数据（例如 tally）。
- **speaker_list_id** — 指向当前或关联的发言名单。
- **created_at** — 创建时间。
- **updated_at** — 修改时间。

------

## 发言名单、动议与投票

### SpeakerLists

- **id** — 发言名单主键。
- **committee_id** — 发言名单所属会场。
- **name** — 名单名称，用于区分（主发言名单、个人演讲名单等）。
- **unit_time** — 单位时间。
- **created_at** — 创建时间。
- **updated_at** — 修改时间。

### SpeakerListEntries

- **id** — 发言名单条目主键。
- **speaker_list_id** — 关联发言名单。
- **delegate_id** — 发言者（Delegates 表），用于排队与权限校验。
- **position** — 在名单中的顺序编号，用于快速查找下一位。
- **status** — 条目状态（waiting/speaking/removed），用于前端高亮与计时。
- **created_at** — 记录加入时间。
- **updated_at** — 最近状态变化时间。

### Motions

- **id** — 动议主键。
- **session_id** — 动议关联的会期（如果是会期内的动议）。
- **motion_type** — 动议类别标识（如 open_speaker_list、suspension、reading_document 等）。
- **proposer_id** — 发起者（Delegates.id 或 Users.id），用于责任与附议来源。
- **file_id** — 关联的文件id。
- **unit_time_seconds** — 若动议涉及单位时长，记录该值。
- **total_time_seconds** — 若动议设定整个阶段总时长，记录该值。
- **requires_list** — 是否需要发言名单才能生效（如主发言名单需 true）。
- **vote_required** — 是否需要投票表决。
- **veto_applicable** — 此动议或其结果是否允许被否决。
- **state** — 动议判定结果（通过/否决/驳回）。
- **vote_result** — 存放动议最终投票详情汇总。
- **created_at** — 发起时间。
- **updated_at** — 状态更新时间。

### Votes

- **id** — 投票记录主键。
- **motion_id** — 存放动议 id。
- **voter_delegate_id** — 表决者的代表 id，用于验证资格。
- **vote** — 投票选项（yes/no/abstain），用于汇总与显示结果。
- **is_veto** — 标记该条投票是否被记作一票否决（用于区分常规票与否决票）。
- **created_at** — 投票时间戳，用于审计与顺序重放。

------

## 文件、否决与危机相关

### Files

- **id** — 文件主键。
- **committee_id** — 关联会场（null 表示全体或非会场特定文件）。
- **type** — 文件类型（position_paper/working_paper/draft_resolution/press_release/other），用于渲染与权限。
- **title** — 文件标题，便于列表与通知。
- **description** — 文件摘要或说明，供审稿人快速了解内容。
- **content_path** — 存储在对象存储的路径或指向文档的索引，便于下载/展示。
- **submitted_by** — 提交该文件的用户 id。
- **submitted_at** — 提交时间。
- **status** — 文件生命周期状态（draft/submitted/approved/published/rejected），控制展示与可操作性。
- **visibility** — 文件可见范围（committee_only/all_committees/public），保障信息隔离。
- **dias_fb** — 主席反馈或主席注释字段（Dias feedback），供主席团记录。
- **created_at** — 文件记录创建时间。
- **updated_at** — 最后修改时间。

### Crises

- **id** — 危机条目主键。
- **title** — 危机短标题，用于通知与列表。
- **content** — 危机详情描述，含情境、要求与时间点。
- **file_path** — 若危机附带文件，存储其对象存储路径。
- **published_by** — 发布该危机的用户 id（通常为组织方或剧本管理员）。
- **published_at** — 发布时间戳。
- **target_committees** — 接收危机的会场 id 列表，用于定向通知与权限控制。
- **responses_allowed** — 是否允许代表提交回应（文件或文字）。
- **created_at** — 记录创建时间。
- **updated_at** — 最后更新。

------

## 时间轴、消息与附件

### Timelines

- **id** — 时间轴事件主键。
- **committee_id** — 该时间点所属的会场，用于回放与同步。
- **real_time** — 现实世界时间戳（UTC），记录事件发生的真实时间。
- **simulation_time** — 会内历史时间对应表（虚拟时间），用于向与会者展示“场内时间”。
- **flow_speed** — 时间流速倍率（例如 1x、2x），表明现实时间到模拟时间的转换比。
- **note** — 该时间点的说明或变更原因。
- **created_by** — 记录该时间轴条目的用户 id（通常为主席或管理员）。
- **created_at** — 创建时间。

### Messages

- **id** — 消息主键。
- **time** — 发送时间戳。
- **from_user_id** — 发送者用户 id。
- **to_user_id** — 私聊接收者 id（若为空表示群发或频道消息）。
- **channel** — 消息频道类型（private/committee/global/dais），用于路由与权限。
- **committee_id** — 若为会场频道消息，关联会场 id。
- **content** — 消息正文文本。
- **created_at** — 记录创建时间。

------

## 管理、审计、报表与配置

### Logs

- **id** — 审计条目主键。
- **actor_user_id** — 执行动作的用户 id（或系统用户）。
- **action** — 动作类型描述（例如 motion.create、file.publish、veto.cast）。
- **target_table** — 目标表名（Files、Motions 等），方便检索。
- **target_id** — 目标对象 id，便于直接定位受影响记录。
- **meta_json** — 与动作相关的可扩展数据（旧值/新值/客户端 IP 等）。
- **timestamp** — 事件时间戳，用于回溯与合规审计。
