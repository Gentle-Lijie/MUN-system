# MUN 系统通知测试指南

## 自动消息检测功能

### 新的自动检测机制

- **检测频率**: 每秒检查一次（从每分钟改为每秒）
- **检测内容**: 比较最新消息的内容变化，而不仅仅是数量
- **通知内容**: 显示具体的消息内容（前30字）和发送人
- **智能过滤**: 只有在消息列表页面以外时才显示通知

### 工作原理

1. **每秒轮询**: 自动调用API获取最新消息
2. **内容比较**: 比较最新消息的"发送人:内容"字符串
3. **变化检测**: 如果与上次不同，则认为是新消息
4. **通知推送**: 显示包含发送人和消息内容的通知
5. **页面切换**: 点击通知自动切换到消息列表标签页

### 通知格式

```
标题: MUN 新消息
内容: 发送人姓名: 消息内容前30个字符...
```

### 性能优化

- 只获取第一页消息（最新的消息）
- 使用内容哈希比较，避免误触发
- 8秒显示时间，给用户更多阅读时间

### 基本测试

```javascript
// 发送1条新消息的通知（默认）
testMUNNotification()

// 发送指定数量的新消息通知
testMUNNotification(5)  // 发送5条消息的通知
```

### 重要提示

- **立即可用**: 测试函数在页面加载后立即可用，无需等待组件完全挂载
- **自动权限处理**: 会自动检查和请求通知权限
- **详细日志**: 所有操作都会在控制台显示详细状态信息

### 权限设置

## 调试信息说明

### 自动刷新日志格式

每次自动刷新都会输出详细的调试信息：

```
🔄 [时间戳] 开始获取消息列表...
📊 [时间戳] API响应: { total: X, itemsCount: Y, ... }
📝 [时间戳] 最新消息分析: { sender: "姓名", contentLength: Z, ... }
🔍 [时间戳] 消息比较结果: { hasNewMessage: true/false, ... }
🚨 [时间戳] 通知条件检查: { shouldShowNotification: true/false, ... }
✅ [时间戳] 消息获取完成
```

### 关键检查点

1. **API响应**: 确认后端返回了消息数据
2. **消息分析**: 检查最新消息的发送人和内容
3. **比较结果**: 确认是否检测到新消息
4. **通知条件**: 检查所有通知触发条件是否满足
5. **权限状态**: 确认通知权限是否正确设置

### 常见问题诊断

- **没有刷新日志**: 检查定时器是否正常启动
- **API响应为0**: 后端可能没有消息数据
- **hasNewMessage: false**: 可能是首次加载或消息内容相同
- **shouldShowNotification: false**: 检查是否在消息列表标签页
- **没有通知弹出**: 检查权限状态和浏览器设置

### 通知权限检查

```javascript
// 检查当前通知权限状态
console.log('通知权限状态:', Notification.permission);

// 请求通知权限
Notification.requestPermission().then(permission => {
  console.log('权限请求结果:', permission);
});
```

### 手动触发通知测试

```javascript
// 手动触发通知（绕过所有条件检查）
window.showNewMessageNotification({
  sender: '测试用户',
  content: '这是一条测试消息内容'
});
```

### 调试模式启用

```javascript
// 启用详细调试模式
localStorage.setItem('mun_debug_mode', 'true');

// 禁用调试模式
localStorage.removeItem('mun_debug_mode');
```

**重要**: 由于浏览器安全策略，通知权限必须通过用户点击来请求。

1. **页面顶部状态指示器**:
   - 🔵 **蓝色提示框**: 点击"启用通知"按钮
   - 🟢 **绿色提示框**: 通知已启用
   - 🟡 **黄色警告框**: 权限被拒绝，需要手动在浏览器设置中重新启用

2. **权限请求流程**:
   - 访问 MiniWindow 页面
   - 如果看到蓝色提示框，点击"启用通知"按钮
   - 浏览器会弹出权限请求对话框
   - 选择"允许"即可启用通知

### 测试步骤

1. **启用通知权限**（必须先完成）
2. **打开浏览器控制台**
3. **运行测试命令**

   ```javascript
   testMUNNotification()  // 基本测试
   testMUNNotification(3) // 测试3条消息的通知
   ```

### 预期结果

- **首次运行**: 浏览器会请求通知权限
  - 允许权限 → 显示通知
  - 拒绝权限 → 控制台显示错误信息

- **后续运行**: 直接显示通知

- **通知行为**:
  - 出现在系统通知区域（右下角）
  - 显示 "MUN 系统消息" 标题
  - 显示消息数量
  - 点击通知会切换到消息列表标签页
  - 5秒后自动消失

### 故障排除

1. **点击"启用通知"按钮无反应**
   - 检查浏览器控制台是否有错误信息
   - 确认使用的是现代浏览器（Chrome、Firefox、Edge、Safari）
   - 确保网站运行在 `localhost` 或 `https` 环境下

2. **权限请求对话框不出现**
   - 浏览器可能阻止了弹出窗口
   - 检查地址栏是否有弹出窗口阻止图标
   - 允许弹出窗口后刷新页面重试

3. **权限被拒绝后如何重新启用**
   - 点击浏览器地址栏的锁图标
   - 选择"站点设置"或"网站设置"
   - 找到"通知"选项，设置为"允许"
   - 刷新页面

4. **控制台测试失败**
   - 确保已通过页面按钮启用了通知权限
   - 检查 `Notification.permission` 的值
   - 尝试刷新页面重新初始化

### 权限状态检查

```javascript
// 检查全局函数是否可用
console.log('测试函数存在:', typeof window.testMUNNotification !== 'undefined')
```

## 总结

### 通知系统状态

✅ **已实现功能**:
- 每秒自动检测新消息
- 基于内容变化的智能检测
- 浏览器原生通知推送
- 自动切换到消息标签页
- 详细的调试日志输出

### 调试步骤

1. **打开浏览器控制台** (F12 → Console)
2. **检查权限状态**: `Notification.permission`
3. **观察自动刷新日志**: 每秒的详细调试信息
4. **手动测试通知**: 使用提供的测试函数
5. **分析问题**: 根据日志信息定位问题所在

### 常见问题解决

- **通知不弹出**: 检查浏览器权限设置
- **没有自动刷新**: 检查控制台是否有错误信息
- **消息检测失败**: 查看API响应和内容比较结果
- **权限被拒绝**: 刷新页面重新请求权限

### 技术支持

如果问题仍然存在，请提供：
- 浏览器控制台的完整错误信息
- 调试日志的输出内容
- 通知权限的状态
- 具体的操作步骤和预期结果
```